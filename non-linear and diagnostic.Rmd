---
title: "nonlinear"
author: "Xiaoyang Li"
date: "2019/12/8"
output: html_document
---
```{r}
library(tidyverse)
library(olsrr)
```


Data import
```{r}
data = read_csv('./data/Lawsuit.csv') %>%
  janitor::clean_names() %>%
  mutate(
    gender = factor(gender, levels = c(0,1), labels = c("female","male")),
    clin = factor(clin, levels = c(0,1)),
    cert = factor(cert, levels = c(0,1)),
    rank = factor(rank, levels = c(1,2,3))
  )

data$ln_sal94 = log(data$sal94)
data$ln_sal95 = log(data$sal95)
data$salavg = (data$sal94 + data$sal95)/2
data$ln_salavg = log(data$salavg)
```


```{r}
reg13 = lm(ln_salavg ~ gender*exper + factor(dept) + clin + cert + rank, data = data)
summary(reg13)
```


## Non-linear models
```{r scatter plot}
data %>% 
  ggplot(aes(x = exper, y = ln_salavg)) +
  geom_point() +
  geom_smooth()
```

The only continuous variable is `exper`. So I made scatter plot for `exper` and `ln_salavg`. According to the scatter plot, I hypothesis there is non-linear relationship between `exper` and `ln_salavg`. 


### polynomial

polynomial without center exper
```{r}
data_poly = data %>% 
  mutate(exper_pow2 = exper^2,
         exper_pow3 = exper^3,
         exper_pow4 = exper^4)

poly_exper = lm(ln_salavg ~ gender*exper + factor(dept) + clin + cert + rank + exper + exper_pow2 + exper_pow3 + exper_pow4 , data = data_poly) 

summary(poly_exper)

anova(reg13, poly_exper)

```

polynomial with center exper
```{r}
data_poly_ = data %>% 
  mutate(
    exper_ = exper - mean(exper),
    exper_pow2_ = exper_^2,
    exper_pow3_ = exper_^3,
    exper_pow4_ = exper_^4)


poly_exper_ = lm(ln_salavg ~ gender*exper + factor(dept) + clin + cert + rank + exper_pow2_ + exper_pow3_ + exper_pow4_, data = data_poly_) 

summary(poly_exper_)

anova(reg13, poly_exper_)
```

I add its power 2, 3, 4 to our model and its centering power 2, 3, 4 seperately to create polynomial models. But the summary result indicate there is no association between higher order of `exper` and `ln_salavg`. Alao, p-value of new piecewise model is larger than 0.05. There is no need to use high order model to improve our `reg13`.


### Piecewise model

To make piecewise model, I choose exper = 7.5 and exper = 9 as knots.

```{r piecewise}
data_piecewise = data %>% 
  mutate(spline_7.5 = (exper - 7.5) * (exper >= 7.5),
         spline_9 = (exper - 9) * (exper >= 9))

pw_exper = lm(ln_salavg ~ gender*exper + factor(dept) + clin + cert + spline_7.5 + spline_9 + rank, data = data_piecewise)

summary(pw_exper)

anova(reg13, pw_exper)
```
p-value of 2 spline is larger than 0.05. Alao, p-value of new piecewise model is larger than 0.05. There is no need to use piecewise model to improve our `reg13`.


Diagnostic
```{r}
par(mfrow = c(2,2))
plot(reg13)
ols_plot_resid_stud_fit(reg13)
ols_plot_resid_lev(reg13)
```
Based on the diagnostic plots above, we can see the assumptions hold well. The curves in residuals vs fitted plot are horizontal and bounce around 0 which indicates that constant variance is satisfied in our model. Scale-location plot shows the same thing. One of observations deviates from the normal line on the qq plot. The same observation is close to the 0.5 cook's distance, which mean No.184 observation might be influential.